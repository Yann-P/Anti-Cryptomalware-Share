#! /bin/bash

# Monitor the Samba Log looking for file modification or deletion
#
# When found output a space separated list of the username, and
# modifiy or delete flag and the file path:
#
# <username> <m|d> <file path>
#
# NOTE: Samba should use just one log file and it needs log level 2
# E.g
# [global]
#    log file = /var/log/samba/smb.log
#    log level = 2

#while true; do echo "a"; sleep 1; done;

ME=$(basename $0)

log=/var/log/samba/smb.log
function usage()
{
	echo "Usage: $ME [/path/to/samba/log]

log defaults to $log
" >&2
}

if [ -n "$1" ]
then
	case $1 in
	'-h'|'--help')
		usage ; exit 0
		;;
	'*')
		log=$1
		if [ ! -r $log ]
		then
			err "Cannot read log '$log'"
			usage
			exit 1
		fi
		;;
	esac
fi

# parse the log
tail --lines=0 -f --pid=$$ $log | \
grep --line-buffered ' opened file ' | \
while read username opened file filepath readflag writeflag rest
do
	# assert [ $opened = 'opened' -a $file = 'file' -a -z "$rest" ]
	case "$readflag $writeflag" in
	'read=No write=Yes')
		# create file
		echo "$username c $filepath"
		;;
	'read=No write=No')
		# delete file
		echo "$username d $filepath"
		;;
	'read=Yes write=Yes')
		# overwrite (modify) file
		echo "$username m $filepath"
		;;
	'read=Yes write=No')
		# read file; we dont care
		:
		;;
	*)
		logger -p user.err "$ME: Parsing error"
		;;
	esac
done

exit 0

#
# Examples seen in Samba log which we are trying to parse
# create file: 
## xcs-test opened file foo.dat read=Yes write=Yes (numopen=1)
## xcs-test closed file foo.dat (numopen=0) NT_STATUS_OK
# here foo.dat did not exist on the share
# 
# overwrite file:
## xcs-test opened file e.dat read=Yes write=Yes (numopen=1)
## xcs-test closed file e.dat (numopen=0) NT_STATUS_OK
#
# --> Cannot distinguish between create and modify
#
# delete file:
## xcs-test opened file e.dat read=No write=No (numopen=1)
## xcs-test closed file e.dat (numopen=0) NT_STATUS_OK
#
# read file (no change):
## xcs-test opened file b.dat read=Yes write=No (numopen=1)
## xcs-test closed file b.dat (numopen=0) NT_STATUS_OK
# second example with path
## xcs-test opened file i/a.dat read=Yes write=No (numopen=1)
## xcs-test closed file i/a.dat (numopen=0) NT_STATUS_OK

