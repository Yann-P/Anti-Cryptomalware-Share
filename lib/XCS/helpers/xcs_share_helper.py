# Copyright 2016 Technical University of Denmark
# Yann Pellegrini, Hugo Maxwell Connery
# Licensed under GPLv3

import os
import sys
import subprocess
import logging

def shell(cmd, **kwargs):
	return subprocess.check_output(cmd, shell=True, **kwargs).decode('utf-8')

def is_git_repo(path):
	os.chdir(path)
	try:
		subprocess.check_call("test -d .git", shell=True)
	except subprocess.CalledProcessError as e:
		return False
	return True

def get_ip_addresses(username):	
	res = shell("smbstatus -bn -u %s 2>/dev/null | tail -n 1 | awk '{print $4}' | uniq" % username)
	if res.isspace():
		return []
	return res.splitlines() # to an array

def get_hostname(ip):
	try:
		return shell("timeout 3 nmblookup -A %s | grep \<00\> | grep -v \<GROUP\> | awk '{print $1}'" % ip, timeout=3)
	except:
		return ip

def git_status(path):
	os.chdir(path)
	return shell('git status --porcelain')

def nb_files_changed(path):
	os.chdir(path)
	return int(shell('git status --porcelain | wc -l'))

def rollback(path, ask_for_confirm=True):
	os.chdir(path)
	full_path = os.path.join(os.path.basename(sys.argv[0]), path)

	logging.debug("Share path is " + full_path)

	if not is_git_repo(path):
		logging.error("error: not a git repository.")
		return False

	if git_status(path) == "":
		logging.error("no changes to rollback.")
		return True

	if ask_for_confirm:
		sys.stderr.write("This command will ERASE all changes since the last commit in the repository specified in the conf file.\n")
		sys.stderr.write("Here are the modifications that will be erased:\n")
		sys.stderr.write("---------------\n")
		os.system('git status --short\n')
		sys.stderr.write("---------------\n")
		sys.stderr.write("Are you sure you want to erase all changes in " + full_path + "? [y/N]\n")

	if ask_for_confirm and not input().lower() in {'yes', 'y'}:
		logging.warning("Abort.")
		return False
	else:
		try:
			sys.stderr.write(shell('git reset HEAD --hard') + "\n")
			sys.stderr.write(shell('git clean -fd') + "\n")
		except subprocess.CalledProcessError as e:
			logging.error("Unable to perform rollback: " + str(e) + "\n")
			return False

	logging.debug("Rollback OK.")
	return True
