<h1 id="design-document-for-anti-cryptomalware-share-project">Design Document for anti-cryptomalware share project</h1>
<h2 id="introduction">Introduction</h2>
<h3 id="motivations">Motivations</h3>
<p>This project has originated from the need to protect the DTU against cryptomalware.</p>
<h3 id="goals">Goals</h3>
<ul>
<li>Detect as soon as possible and collect as much information as we can ;</li>
<li>Trigger configurable responses such as notifications ;</li>
<li>Slow down the attack, if possible.</li>
</ul>
<h2 id="tools">Tools</h2>
<ul>
<li>Platform: GNU/Linux</li>
<li>Language: python</li>
<li>Software: Git, Samba</li>
</ul>
<h2 id="thread-tree">Thread tree</h2>
<div class="figure">
<img src="./thread_tree.png" title="Schema of the tree" alt="thread_tree.png" /><p class="caption">thread_tree.png</p>
</div>
<h2 id="design">Design</h2>
<h3 id="configuration-file">Configuration file</h3>
<p>As we need a lot of flexibility, we will have a xcs.conf file</p>
<pre class="sourceCode ini"><code class="sourceCode ini">

<span class="kw">[monitoring]</span>
<span class="dt">location </span><span class="ot">=</span><span class="st"> /path/to/the/share</span>
<span class="dt">monitor_interval </span><span class="ot">=</span><span class="st"> </span><span class="dv">10</span><span class="st"> </span><span class="co"># seconds between checks</span>
<span class="dt">notify_interval </span><span class="ot">=</span><span class="st"> </span><span class="dv">3600</span>

<span class="kw">[notification]</span>
<span class="dt">enable_emails </span><span class="ot">=</span><span class="st"> </span><span class="dv">1</span>
<span class="dt">email_to </span><span class="ot">=</span><span class="st"> hmco rele</span>
<span class="dt">email_domain </span><span class="ot">=</span><span class="st"> env.dtu.dk</span>
<span class="dt">user_warning </span><span class="ot">=</span><span class="st"> </span><span class="dv">1</span>
<span class="dt">user_warning_message </span><span class="ot">=</span><span class="st"> &quot;it looks like you just got pwned :) go see it support asap&quot;</span>

<span class="kw">[log]</span>
<span class="dt">enable_syslog_reporting </span><span class="ot">=</span><span class="st"> </span><span class="dv">1</span>
<span class="dt">enable_logging </span><span class="ot">=</span><span class="st"> </span><span class="dv">1</span>
<span class="dt">log_to </span><span class="ot">=</span><span class="st"> /var/log/xcs/ /var/www/html/crypto-attack.env.dtu.dk/reports </span><span class="co"># will write the same report in every of these folders</span>
</code></pre>
<h3 id="requirements">Requirements</h3>
<p>This tool works by detecting any changes in a samba shared drive and assumes every change in the drive is an attack. So we need a working samba share. It is also important to let users know not to change anything in the drive.</p>
<h3 id="xcs-monitor-daemon"><code>xcs-monitor</code> daemon</h3>
<p>This module will run as a daemon.</p>
<ol style="list-style-type: decimal">
<li>Startup</li>
</ol>
<ul>
<li>Read the configuration file and parse it. If it fails to parse, print a notice and exit the deamon with <code>status code 1</code>.</li>
<li>Request a periodic alarm signal from the kernel, with the interval defined in the configuration file.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Periodic checks</li>
</ol>
<ul>
<li>Check the share defined in the config file for any changes using <code>git status</code>. We want to detect any new file or any change in a file.</li>
<li>We need to do a first parse of the result returned by git to determine if there has been any change at all. If there has been a change, then:</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Gathering data</li>
</ol>
<p>We need to get relevant information about the attack, to then process it in various ways and get a precise report. Here are the elements we are looking for:</p>
<ul>
<li>username of new/modified files</li>
<li>timestamp</li>
<li>list of filenames</li>
<li>IP address of the client</li>
<li>its hostname.</li>
</ul>
<p>Here is the sequential order to get this data. This will be the job of a separate module used for parsing.</p>
<ul>
<li>git will get us the list of modified and new files. We then need to parse it with bash commands such as grep, cut... to make our way to a python array.</li>
<li><code>samba</code> will allow us to get the username of the new/modified files. It will also give us the last modification date (our timestamp)</li>
<li><code>smbstatus -u &lt;username&gt;</code> will allow us to parse the IP out of the result</li>
<li><code>nmblookup -A &lt;ip&gt;</code> to get the username.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Distinguish different attacks</li>
</ol>
<p>We want to notify the <code>xcs-response</code> module with data about the attack, for each distinct attack. A distinct attack is defined as a primary key of the following tree identifiers: (username, IP, hostname). To perform this check, we will store occuring attacks in RAM and check the primary key of the decteted change against all occuring attacks stored as an array. We can also compute an <code>attack_id</code> by hashing the primary key.</p>
<ol start="5" style="list-style-type: decimal">
<li>Reporting to <code>xcs-response</code> module</li>
</ol>
<ul>
<li>If it is a new attack we can spawn a response thread, passing it the data we gathered as an argument.</li>
<li>We also want to pass the configuration to <code>xcs-response</code>Â as it defines which actions should be taken.</li>
<li>Then, we want to tell it whether it should or not notify based on the time remaining on <code>notify_interval</code>. This has to be stored as a hashmap<attackid, last_notification_timestamp> in this monitor module.</li>
</ul>
<p>Nb: we can determine when the rollback has happened by checking if <code>git status</code> is empty. We can as well assume the attack is over when git status is the same as the previous git status.</p>
<h3 id="xcs-response-module"><code>xcs-response</code> module</h3>
<p>This module will be run in a different thread per distinct attack. It will be given all the data about an occuring attack. One or more actions will be taken depending on the current <em>policy</em> defined in the configuration file.</p>
<p>The essential ones are the following:</p>
<ul>
<li>Notifications.</li>
<li>User warning by sending an email to the address (<code>{username}@env.dtu.dk</code> where username is the user who modified/created the files)</li>
<li>Send emails to each specified address with the above details <em>and</em> the number of files</li>
<li>Logging</li>
<li>Write a report (.log) named <code>xcs_attack_{datetime}_{hostname.log}</code> in every specified folder</li>
<li>Write a line to syslog</li>
</ul>
<p><code>{datetime} xcs: attack user={username} ip={ip} host={hostname} numfiles={n}</code>, where <em>n</em> = number of files sent by <code>xcs-monitor</code>.</p>
<p>We can use abstract classes such as <code>Notifier</code>, <code>Logger</code>... to make it easy to extend the existing functionnalities without having to change much of the code.</p>
