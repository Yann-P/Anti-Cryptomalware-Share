# Design Document for anti-cryptomalware share project

## Introduction
### Motivations

This project has originated from the need to protect the DTU against cryptomalware.

### Goals

* Detect as soon as possible and collect as much information as we can ;
* Trigger configurable responses such as notifications ;
* Slow down the attack, if possible.

## Tools

* Platform: GNU/Linux
* Language: python
* Software: Git, Samba

## Thread tree

![thread_tree.png](./thread_tree.png "Schema of the tree")

## Design

### Configuration file
As we need a lot of flexibility, we will have a xcs.conf file

```ini

[global]
samba_log = /var/log/samba/smb.log
auto_rollback = 1

[monitor]
frequency = 3
share_git_dir = /home/sambashare/
share_data_dir = /home/sambashare/data
basenames_to_ignore = thumbs.db desktop.ini

[notify]
interval = 60

email_hostname=localhost
email_port=25
email_from=yannp@do-not-touch.env.dtu.dk

notify_admins = 1
notify_victim = 1

admins_usernames = hmco foobar
email_domain = env.dtu.dk
user_email_body_path = etc/user_notice_email_body.txt
user_email_subject = DTU env. I.T. dpt: cryptomalware activity originated from your account.

[log]
enable_syslog_reporting = 1
enable_file_logs = 1
file_logs_dir = logs/

```
### Requirements

This tool works by detecting any changes in a samba shared drive and assumes every change in the drive is an attack. So we need a working samba share.
It is also important to let users know not to change anything in the drive.

### `xcs-monitor` daemon

This module will run as a daemon.

1. Startup

  * Read the configuration file and parse it. If it fails to parse, print a notice and exit the deamon with `status code 1`.
  * Request a periodic alarm signal from the kernel, with the interval defined in the configuration file.
  * Setup a `tail -f` to the samba log to detect changes
  * Also listen for SIGUSR1 to print information about current attacks.

2. Periodic checks

  * Check the share defined in the config file for any changes using the samba log module. We want to detect any new file or any change in a file, as well as deleted files.
  * The samba log modules works by creating a subprocess that runs a `tail -f` and parses its output. It then keeps a record of which user did which damage
    (a damage object is essentially 3 integers for the number of created, modified and deleted files).
  * If there has been a change, then:

3. Gathering data

   We need to get relevant information about the attack, to then process it in various ways and get a precise report. Here are the elements we are looking for:

  * username of new/modified files
  * timestamp
  * list of filenames
  * IP address of the client
  * its hostname.

   Here is the sequential order to get this data. This will be the job of a separate module used for parsing.

  * the samba log tells us the username, the type of modification.
  * `smbstatus -u <username>` will allow us to parse the IP out of the result
  * `nmblookup -A <ip>` to get the hostname.

4. Distinguish different attacks

   We want to notify the `xcs-response` module with data about the attack, for each distinct attack. 
   A distinct attack is defined as a primary key of the following tree identifiers: (username, IP, hostname).
   To perform this check, we will store occuring attacks in RAM and check the primary key of the decteted change against all occuring attacks stored as an array.
   We also give the attack an id that consists of the datetime and an integer that increments at each new attack of this xcs-monitor process.

5. Reporting to `xcs-response` module

   * If it is a new attack, or the attack is updated with *new* damage information, or the attack is completed we spawn a response thread and pass it the config, the attack object
     and the attack status (NEW, UPDATED or OVER).
   * Based on the config, the response thread will instanciate the appropriate loggers and notifiers. The classes xcs_logger and xcs_notifier can easily be extended.


Nb: we can determine when the rollback has happened by checking if `git status` is empty. We can as well assume the attack is over when git status is the same as the previous git status.
There is an option in the config that performs an "auto-rollback".

### `xcs-response` module

This module will be run in a different thread per distinct attack. It will be given all the data about an occuring attack, and the status of the attack.
One or more actions will be taken depending on the current *policy* defined in the configuration file.

The essential ones are the following:

* Notifications.
  * "Victim" warning by sending an email to the address (`{username}@env.dtu.dk` where username is the user who modified/created the files)
  * Send emails to each specified admin address with the above details *and* the technical details
* Logging
  * Write a report (.log) named `attack_{datetime}_{hostname.log}` in a directory specified in the config.
  * Write a line to syslog

`{datetime} xcs: attack user={username} ip={ip} host={hostname} numfiles={n}`, where *n* = number of files sent by `xcs-monitor`.